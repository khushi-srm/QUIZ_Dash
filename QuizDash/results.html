<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Results - Quizzo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #9DB2BF;
        }
        .container {
            max-width: 1000px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #27374D;
            text-align: center;
            margin-bottom: 30px;
        }
        .quiz-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #27374D;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }
        .attempts-list {
            margin-top: 20px;
        }
        .attempt-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .attempt-score {
            font-weight: bold;
            font-size: 18px;
        }
        .score-excellent { color: #27AE60; }
        .score-good { color: #F39C12; }
        .score-poor { color: #E74C3C; }
        .back-btn {
            background: #526D82;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        .back-btn:hover {
            background: #27374D;
        }
        .no-attempts {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="home.html" class="back-btn">‚Üê Back to Dashboard</a>
        
        <h1 id="quizTitle">Quiz Results</h1>
        
        <div class="quiz-info" id="quizInfo">
            <h3>Quiz Information</h3>
            <p><strong>Created:</strong> <span id="createdDate"></span></p>
            <p><strong>Questions:</strong> <span id="questionCount"></span></p>
            <p><strong>Privacy:</strong> <span id="privacy"></span></p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalAttempts">0</div>
                <div>Total Attempts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageScore">0%</div>
                <div>Average Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highestScore">0%</div>
                <div>Highest Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionRate">0%</div>
                <div>Completion Rate</div>
            </div>
        </div>
        
        <div class="attempts-list">
            <h3>Recent Attempts</h3>
            <div id="attemptsList">
                <div class="no-attempts">No attempts yet</div>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="database.js"></script>
    <script>
        // Check if user is logged in
        if (!isLoggedIn()) {
            window.location.href = 'index.html';
        }

        function getQuizIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        function loadQuizResults() {
            const quizId = getQuizIdFromUrl();
            if (!quizId) {
                alert('Quiz not found!');
                window.location.href = 'home.html';
                return;
            }

            const quiz = getQuiz(quizId);
            if (!quiz) {
                alert('Quiz not found!');
                window.location.href = 'home.html';
                return;
            }

            // Check if current user owns this quiz
            const currentUser = getCurrentUser();
            if (quiz.creatorEmail !== currentUser.email) {
                alert('You can only view results for your own quizzes!');
                window.location.href = 'home.html';
                return;
            }

            // Display quiz info
            document.getElementById('quizTitle').textContent = `Results: ${quiz.title}`;
            document.getElementById('createdDate').textContent = new Date(quiz.createdAt).toLocaleDateString();
            document.getElementById('questionCount').textContent = quiz.questions.length;
            document.getElementById('privacy').textContent = quiz.privacy.charAt(0).toUpperCase() + quiz.privacy.slice(1);

            // Get attempts for this quiz
            const attempts = getQuizAttempts(quizId);
            
            if (attempts.length === 0) {
                document.getElementById('attemptsList').innerHTML = '<div class="no-attempts">No attempts yet</div>';
                return;
            }

            // Calculate statistics
            const totalAttempts = attempts.length;
            const scores = attempts.map(attempt => attempt.score);
            const averageScore = Math.round(scores.reduce((sum, score) => sum + score, 0) / scores.length);
            const highestScore = Math.max(...scores);
            const completionRate = 100; // All attempts in our system are completed

            // Update stats
            document.getElementById('totalAttempts').textContent = totalAttempts;
            document.getElementById('averageScore').textContent = averageScore + '%';
            document.getElementById('highestScore').textContent = highestScore + '%';
            document.getElementById('completionRate').textContent = completionRate + '%';

            // Display attempts
            const attemptsList = document.getElementById('attemptsList');
            attemptsList.innerHTML = attempts
                .sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt))
                .map(attempt => {
                    const scoreClass = attempt.score >= 80 ? 'score-excellent' : 
                                     attempt.score >= 60 ? 'score-good' : 'score-poor';
                    
                    const timeSpent = attempt.timeSpent;
                    const minutes = Math.floor(timeSpent / 60);
                    const seconds = timeSpent % 60;
                    
                    return `
                        <div class="attempt-item">
                            <div>
                                <strong>${attempt.userEmail}</strong><br>
                                <small>${new Date(attempt.completedAt).toLocaleString()}</small><br>
                                <small>Time: ${minutes}m ${seconds}s</small>
                            </div>
                            <div class="attempt-score ${scoreClass}">
                                ${attempt.score}%<br>
                                <small>(${attempt.correctAnswers}/${attempt.totalQuestions})</small>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // Load results on page load
        loadQuizResults();
    </script>
</body>
</html>